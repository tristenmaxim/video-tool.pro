<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DOWNLOAD‑VIDEO.PRO</title>

    <!-- React + Babel (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-black text-white">
    <div id="root"></div>

    <script type="text/babel">
      const { useState } = React;

      const DownloadButton = ({ onClick, loading }) => (
        <button
          onClick={onClick}
          disabled={loading}
          className={`w-full text-3xl font-bold border-4 border-black rounded p-2 transition-colors duration-200 ${loading ? 'bg-gray-600 cursor-not-allowed' : 'bg-white text-black hover:bg-gray-300'}`}
        >
          {loading ? 'DOWNLOADING…' : 'DOWNLOAD'}
        </button>
      );

      const MessageBox = ({ message, type }) => {
        const color = type === 'error' ? 'red' : 'green';
        return (
          <div className={`mt-4 w-3/4 border-4 border-${color}-600 p-4 rounded-lg text-xl text-${color}-400`}>
            {message}
          </div>
        );
      };

      const App = () => {
        const [url, setUrl] = useState('');
        const [loading, setLoading] = useState(false);
        const [msg, setMsg] = useState({ text: '', type: 'error' });

        async function handleDownload() {
          setMsg({ text: '', type: 'error' });
          if (!url) {
            setMsg({ text: 'ENTER A URL FIRST', type: 'error' });
            return;
          }

          setLoading(true);
          try {
            // POST to backend and receive the video as streamed response
            const res = await fetch('http://localhost:3000/download', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url }),
            });

            if (!res.ok) {
              const errText = await res.text();
              throw new Error(errText || 'DOWNLOAD FAILED');
            }

            // Extract a filename from Content-Disposition header if present
            let filename = 'video.mp4';
            const disposition = res.headers.get('Content-Disposition');
            if (disposition && disposition.includes('filename=')) {
              filename = decodeURIComponent(
                disposition.split('filename=')[1].replace(/"/g, '')
              );
            }

            // Convert response stream to Blob
            const blob = await res.blob();

            // Trigger browser download
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show success message
            setMsg({ text: 'FINISHED!', type: 'success' });
            setTimeout(() => setMsg({ text: '', type: 'error' }), 3000);
          } catch (err) {
            setMsg({ text: `ERROR: ${err.message}`, type: 'error' });
          } finally {
            setLoading(false);
          }
        }

        return (
          <div className="h-screen flex flex-col items-center justify-center border-4 border-white m-4 rounded-lg p-4 space-y-8">
            <h1 className="text-5xl border-b-4 border-white pb-2">DOWNLOAD‑VIDEO.PRO</h1>

            <div className="w-3/4 space-y-4">
              <input
                type="text"
                value={url}
                onChange={(e) => setUrl(e.target.value)}
                placeholder="PASTE URL HERE"
                className="w-full text-2xl bg-black border-2 border-white p-2 rounded focus:outline-none"
              />

              <DownloadButton onClick={handleDownload} loading={loading} />
            </div>

            {msg.text && <MessageBox message={msg.text} type={msg.type} />}
          </div>
        );
      };

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
